# .github/workflows/e2e-tests.yml
name: E2E ReplicaSet Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create false

      - name: Install Python dependencies
        run: |
          poetry install --no-interaction --no-root

      - name: Map db.internal to localhost
        run: |
          echo "127.0.0.1 rs00 rs01 rs02 rs10 rs11 rs12" | sudo tee -a /etc/hosts

      - name: Start source and target ReplicaSets
        run: |
          echo "Starting source and target ReplicaSets..."
          .github/workflows/rs/rr

      - name: Build the project
        run: |
          echo "Building project..."
          # Add your build steps here if necessary

      - name: Start Go service in background
        run: |
          echo "Starting Go service..."
          nohup go run main.go heartbeat.go recovery.go \
            --source="mongodb://adm:pass@rs00:30000" \
            --target="mongodb://adm:pass@rs10:30100" \
            --reset-state --start > go_service.log 2>&1 &
          sleep 5  # Give it time to start

      # - name: Start project in background
      #   run: |
      #     echo "Starting project..."
      #     go run main.go heartbeat.go recovery.go --source="mongodb://adm:pass@rs00:30000" --target="mongodb://adm:pass@rs10:30100" --reset-state --start
      #     sleep 5  # Allow the app to start

      - name: Run E2E tests with pytest
        run: |
          export TEST_SOURCE_URI=mongodb://adm:pass@rs00:30000
          export TEST_TARGET_URI=mongodb://adm:pass@rs10:30100
          export TEST_MONGOLINK_URL=http://localhost:2242
          # poetry run pytest
          poetry run pytest -v -s tests/test_documents.py::test_update_one_complex

      - name: Teardown Docker Compose
        if: always()
        run: docker compose -f .github/workflows/rs/compose.yml down
